<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Python æµ·é¾Ÿç¼–è¾‘å™¨ - TURTLE</title>
    <!-- åŠ è½½ static æ¨¡æ¿æ ‡ç­¾ -->
    {% load static %}
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            overflow: hidden; /* æ”¹å›hiddenç¦æ­¢æ•´ä½“æ»šåŠ¨ */
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #FFD700; /* é»„è‰²èƒŒæ™¯ */
            color: #333;
            padding: 6px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            height: 45px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-button {
            background: none;
            border: none;
            color: #555;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-button:hover {
            color: #E65100;
        }

        .header-center {
            display: flex;
            align-items: center;
        }
        
        .mode-btn-group {
            display: flex;
            background-color: #F8F8F8;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .mode-btn {
            background: none;
            border: none;
            padding: 6px 15px;
            font-size: 14px;
            cursor: pointer;
            color: #555;
        }
        
        .mode-btn.active {
            background-color: #E65100;
            color: white;
        }
        
        .header-label {
            margin-left: 15px;
            font-size: 14px;
            color: #333;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-work-btn {
            cursor: pointer;
            color: #333;
            font-size: 14px;
        }
        
        .header-action-btn {
            background-color: #FF9800;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .header-action-btn.purple {
            background-color: #9C27B0;
        }
        
        .login-btn {
            background: none;
            border: 1px solid #666;
            border-radius: 4px;
            color: #333;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-container {
            display: flex;
            flex-direction: row;
            height: calc(100vh - 45px); /* è®¾ç½®å›ºå®šé«˜åº¦ */
            margin-top: 45px;
            overflow: hidden; /* ç¦æ­¢å®¹å™¨æ»šåŠ¨ */
        }
        
        /* å·¦ä¾§å¯¼èˆª */
        .sidebar {
            width: 180px;
            background-color: #f8f8f8;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .file-nav {
            padding: 8px 0;
        }
        
        .file-item {
            padding: 6px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .file-item.active {
            background-color: #E3F2FD;
            color: #1976D2;
        }
        
        .file-icon {
            color: #FF9800;
            font-size: 16px;
        }
        
        /* æ–‡ä»¶æ ‡ç­¾é¡µ */
        .file-tabs {
            display: flex;
            background-color: #f8f8f8;
            border-bottom: 1px solid #ddd;
            height: 30px;
        }
        
        .file-tab {
            padding: 6px 15px;
            font-size: 13px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
            border-right: 1px solid #ddd;
            position: relative;
            background-color: white;
            border-bottom: 2px solid #1976D2;
        }
        
        .file-tab-close {
            font-size: 14px;
            margin-left: 5px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .file-tab-close:hover {
            opacity: 1;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-left: 1px solid #eee;
            overflow: hidden; /* ç¦æ­¢å†…å®¹åŒºåŸŸæ»šåŠ¨ */
        }
        
        /* ç¼–è¾‘å™¨å®¹å™¨ */
        .editor-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* ç¦æ­¢æ•´ä¸ªç¼–è¾‘å™¨å®¹å™¨æ»šåŠ¨ */
        }
        
        /* ç§¯æœ¨ç¼–è¾‘å™¨ */
        .blocks-editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
            display: none;
        }
        
        .blocks-mode .blocks-editor {
            display: block;
        }
        
        .blocks-mode .code-editor {
            display: none;
        }
        
        /* ä»£ç ç¼–è¾‘å™¨ */
        .code-editor {
            flex: 1;
            position: relative;
            width: 100%;
            overflow: auto; /* ä¿ç•™autoå…è®¸ä»£ç ç¼–è¾‘åŒºæ»šåŠ¨ */
            height: 100%; /* è®¾ç½®é«˜åº¦ä¸º100%å¡«å……å®¹å™¨ */
        }
        
        /* è¾“å‡ºåŒºåŸŸ */
        .output-container {
            z-index: 900;
            position: fixed; /* æ”¹ä¸ºfixedå®šä½ */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f8f8;
            padding: 6px 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .output-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .output-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .output-control-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }
        
        .output-control-btn:hover {
            background-color: #e0e0e0;
        }
        
        .output-control-btn i {
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: normal;
        }
        
        #zoomLevel {
            font-size: 12px;
            color: #555;
            width: 40px;
            text-align: center;
        }
        
        .grid-background {
            background-image: linear-gradient(#eee 1px, transparent 1px), 
                              linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .canvas-container {
            flex: 1;
            background-color: white;
            overflow: auto; /* æ”¹ä¸ºautoå…è®¸æ»šåŠ¨ */
            position: relative;
            min-height: 200px;
        }
        
        .console-output {
            height: 60px;
            padding: 6px 10px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 13px;
            background-color: #f8f8f8;
            overflow-y: auto;
            border-top: 1px solid #ddd;
        }
        
        #output {
            margin: 0;
            white-space: pre-wrap;
            color: #333;
        }
        
        /* æˆåŠŸæ¶ˆæ¯æ ·å¼ */
        .success-message {
            color: #4CAF50;
            font-weight: bold;
        }
        
        /* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
        .error-message {
            color: #F44336;
            font-weight: bold;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            right: 0;
            width: auto;
            height: 35px;
            background-color: #f8f8f8;
            border-top: 1px solid #ddd;
            border-left: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
        }
        
        /* è¿è¡Œæ§åˆ¶æŒ‰é’®ç»„ */
        .control-buttons {
            position: fixed;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .btn-group {
            display: flex;
            gap: 4px;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #555;
            cursor: pointer;
            border: none;
        }

        .run-btn {
            background-color: #4CAF50;
            color: white;
        }

        .debug-btn {
            background-color: #2196F3;
            color: white;
        }
        
        /* AIåŠ©æ‰‹æ ·å¼ */
        .ai-assistant {
            position: absolute;
            top: -80px;
            right: 50px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px;
            width: 240px;
            display: none;
            align-items: center;
            z-index: 1000;
        }
        
        .ai-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #E1F5FE;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 18px;
            color: #039BE5;
        }
        
        .ai-message {
            flex: 1;
            font-size: 12px;
            color: #555;
            line-height: 1.4;
        }
        
        /* å·¥å…·æŒ‰é’® */
        .tool-buttons {
            position: fixed;
            right: 20px;
            top: 80%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 950;
        }
        
        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .tool-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* CodeMirror è‡ªå®šä¹‰æ ·å¼ */
        .CodeMirror {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 15px;
            line-height: 1.5;
            height: auto !important; /* å…è®¸è‡ªåŠ¨å¢é•¿é«˜åº¦ */
            min-height: 100%; /* æœ€å°é«˜åº¦è®¾ä¸º100% */
        }
        
        .CodeMirror-gutters {
            border-right: 1px solid #eee;
            background-color: #f8f8f8;
        }

        /* åº•éƒ¨æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .bottom-control-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            background-color: #fff;
            border-radius: 20px;
            padding: 5px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            position: relative;
        }

        .control-btn:hover {
            background-color: #f0f0f0;
        }

        .control-btn:hover::after {
            content: attr(title);
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
            padding: 0 5px;
            margin: 0 5px;
        }

        .zoom-level-bottom {
            font-size: 14px;
            color: #666;
            width: 40px;
            text-align: center;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 18px;
            border: none;
            background-color: transparent;
            color: #666;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-btn:hover {
            background-color: #f0f0f0;
        }

        .debug-btn {
            background-color: #2196F3;
            color: white;
        }

        .debug-btn:hover {
            background-color: #1976D2;
        }

        .run-btn-bottom {
            background-color: #FF9800;
            color: white;
        }

        .run-btn-bottom:hover {
            background-color: #F57C00;
        }

        .stop-btn-bottom {
            background-color: #F44336;
            color: white;
            display: none;
        }

        .stop-btn-bottom:hover {
            background-color: #D32F2F;
        }

        /* æ·»åŠ åº•éƒ¨æ§åˆ¶å°æ ·å¼ */
        .bottom-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background-color: #2d2d2d;
            color: #f0f0f0;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 14px;
            z-index: 1100;
            display: none;
            flex-direction: column;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }

        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1e1e1e;
            padding: 5px 10px;
            border-bottom: 1px solid #333;
        }

        .console-title {
            font-weight: 600;
            color: #f0f0f0;
            font-size: 14px;
        }

        .console-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .console-control-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #ccc;
            font-size: 14px;
            padding: 4px;
            border-radius: 3px;
        }

        .console-control-btn:hover {
            background-color: #444;
        }

        .console-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .debug-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 250px;
            background-color: #f8f8f8;
            border-top: 1px solid #ddd;
            z-index: 1100;
            display: none;
            flex-direction: column;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f0f0;
            padding: 8px 15px;
            border-bottom: 1px solid #ddd;
        }

        .debug-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .debug-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debug-control-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            font-size: 14px;
            padding: 4px;
            border-radius: 3px;
        }

        .debug-control-btn:hover {
            background-color: #e0e0e0;
        }

        .debug-panel {
            display: flex;
            height: calc(100% - 37px);
        }

        .debug-variables {
            width: 250px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }

        .debug-console-output {
            flex: 1;
            padding: 10px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            font-size: 13px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* æ·»åŠ ç½‘é¡µå†…æœ€å¤§åŒ–æ ·å¼ */
        .maximized-output {
            position: fixed !important;
            top: 45px !important; /* é¡¶éƒ¨å¯¼èˆªæ ä¸‹æ–¹ */
            left: 0 !important;
            width: 100% !important;
            height: calc(100vh - 45px) !important;
            transform: none !important;
            border-radius: 0 !important;
            z-index: 1000 !important;
        }

        .maximized-output .canvas-container {
            height: calc(100% - 80px) !important; /* å‡å»å¤´éƒ¨å’Œåº•éƒ¨åŒºåŸŸçš„é«˜åº¦ */
        }

        /* è‡ªå®šä¹‰å…¨å±å›¾æ ‡ */
        .fullscreen-icon-expand, .fullscreen-icon-collapse {
            width: 16px;
            height: 16px;
            display: block;
        }

        .fullscreen-icon-collapse {
            display: none;
        }

        .maximized-output .fullscreen-icon-expand {
            display: none;
        }

        .maximized-output .fullscreen-icon-collapse {
            display: block;
        }

        /* æ·»åŠ ä¾§è¾¹æ æŒ‰é’®æ ·å¼ */
        .sidebar-actions {
            display: flex;
            justify-content: space-around;
            padding: 8px 5px;
            border-bottom: 1px solid #ddd;
            background-color: #f0f0f0;
        }

        .sidebar-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .sidebar-btn:hover {
            background-color: #e0e0e0;
        }

        .sidebar-btn svg {
            opacity: 0.8;
        }

        .sidebar-btn:hover svg {
            opacity: 1;
        }

        /* ä¿®æ”¹sidebaræ ·å¼ä½¿å…¶å¯ä»¥æŠ˜å  */
        .sidebar.collapsed {
            width: 40px;
        }

        .sidebar.collapsed .file-nav, 
        .sidebar.collapsed .file-item span:not(.file-icon) {
            display: none;
        }

        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: absolute;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            min-width: 150px;
            z-index: 1050;
            display: none;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        .context-menu-divider {
            height: 1px;
            background-color: #eee;
            margin: 5px 0;
        }

        .context-menu-icon {
            color: #555;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }
    </style>
    <!-- é™æ€æ–‡ä»¶å¼•å…¥ -->
    <script src="{% static 'js/skulpt.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/skulpt-stdlib.js' %}" type="text/javascript"></script>
    <link href="{% static 'codemirror/lib/codemirror.css' %}" rel="stylesheet" type="text/css">
    <script src="{% static 'codemirror/lib/codemirror.js' %}"></script>
    <script src="{% static 'codemirror/mode/python/python.js' %}"></script>
    <!-- æ·»åŠ CodeMirroræ»šåŠ¨æ¡æ’ä»¶ -->
    <link href="{% static 'codemirror/addon/scroll/simplescrollbars.css' %}" rel="stylesheet" type="text/css">
    <script src="{% static 'codemirror/addon/scroll/simplescrollbars.js' %}"></script>
</head>

<body class="code-mode">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
        <div class="header-left">
            <a href="{% url 'index' %}" class="nav-button">â—€</a>
            <a href="{% url 'index' %}" class="nav-button">ğŸ </a>
            <a href="#" class="nav-button">ğŸ“</a>
            <a href="#" class="nav-button">âš™ï¸</a>
            <a href="#" class="nav-button">â“</a>
        </div>
        <div class="header-center">
            <div class="mode-btn-group">
                <button class="mode-btn" id="blocksBtn">ç§¯æœ¨</button>
                <button class="mode-btn active" id="codeBtn">ä»£ç </button>
            </div>
        </div>
        <div class="header-right">
            <span class="new-work-btn">æ–°çš„ä½œå“</span>
            <button class="header-action-btn" onclick="saveFile()">ä¿å­˜</button>
            <button class="header-action-btn purple" onclick="shareCode()">åˆ†äº«</button>
            <button class="login-btn">ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <!-- å·¦ä¾§å¯¼èˆª -->
        <div class="sidebar">
            <!-- æ·»åŠ æ–‡ä»¶ç®¡ç†æŒ‰é’® -->
            <div class="sidebar-actions">
                <button class="sidebar-btn" title="æ”¶èµ·ç®¡ç†å™¨" id="foldSidebarBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="#666">
                        <path d="M3 18h13v-2H3v2zm0-5h10v-2H3v2zm0-7v2h13V6H3zm18 9.59L17.42 12 21 8.41 19.59 7l-5 5 5 5L21 15.59z"/>
                    </svg>
                </button>
                <button class="sidebar-btn" title="æ·»åŠ .pyæ–‡ä»¶" id="addPyFileBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="#FF9800">
                        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                    </svg>
                </button>
                <button class="sidebar-btn" title="æ·»åŠ ç´ æ" id="addResourceBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="#4CAF50">
                        <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
                    </svg>
                </button>
                <button class="sidebar-btn" title="æ·»åŠ æ–‡ä»¶å¤¹" id="addFolderBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="#2196F3">
                        <path d="M20 6h-8l-2-2H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm0 12H4V8h16v10z"/>
                    </svg>
                </button>
                <button class="sidebar-btn" title="æ·»åŠ æœ¬åœ°æ–‡ä»¶" id="addLocalFileBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="#9E9E9E">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                </button>
            </div>

            <div class="file-nav">
                <div class="file-item active">
                    <span class="file-icon">ğŸ”¶</span>
                    <span>main.py</span>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content-area">
            <!-- æ–‡ä»¶æ ‡ç­¾é¡µ -->
            <div class="file-tabs">
                <div class="file-tab">
                    main.py
                    <span class="file-tab-close">Ã—</span>
                </div>
            </div>

            <!-- ç¼–è¾‘å™¨å®¹å™¨ -->
            <div class="editor-container">
                <!-- ç§¯æœ¨ç¼–è¾‘å™¨ -->
                <div class="blocks-editor">
                    <div class="blocks-group">
                        <!-- ç§¯æœ¨å—å°†åœ¨åˆ‡æ¢åˆ°ç§¯æœ¨æ¨¡å¼æ—¶æ˜¾ç¤º -->
                    </div>
                </div>
                
                <!-- ä»£ç ç¼–è¾‘å™¨ -->
                <div class="code-editor">
                    <textarea id="yourcode">import turtle

# åˆ›å»ºç”»ç¬”å¯¹è±¡
p = turtle.Turtle()
p.pensize(3)
p.pencolor('gold')

# è®¾ç½®è¾¹æ•°
n = 6

# å¤–å±‚å¾ªç¯ - ç»˜åˆ¶5ä¸ªå›¾å½¢
for j in range(5):
    # å†…å±‚å¾ªç¯ - ç»˜åˆ¶ä¸€ä¸ªnè¾¹å½¢
    for i in range(n):
        p.forward(100)
        p.left(int(360/n))
    # æ¯ä¸ªå›¾å½¢åæ—‹è½¬
    p.left(int(360/5))

print("ç»˜åˆ¶å®Œæˆ")</textarea>
                </div>
                
                <!-- è¾“å‡ºåŒºåŸŸ - åˆå§‹éšè—ï¼Œè¿è¡Œåæ˜¾ç¤º -->
                <div class="output-container" style="display: none;">
                    <div class="output-header">
                        <div class="output-title">æµ·é¾Ÿå›¾</div>
                        <div class="output-controls">
                            <button class="output-control-btn" id="gridBtn" title="æ˜¾ç¤º/éšè—ç½‘æ ¼"><i>ğŸ“</i></button>
                            <button class="output-control-btn" id="zoomOutBtn" title="ç¼©å°"><i>â–</i></button>
                            <span id="zoomLevel">100%</span>
                            <button class="output-control-btn" id="zoomInBtn" title="æ”¾å¤§"><i>â•</i></button>
                            <button class="output-control-btn" id="resetZoomBtn" title="è¿˜åŸå¤§å°"><i>ğŸ”„</i></button>
                            <button class="output-control-btn" id="screenshotBtn" title="æˆªå›¾"><i>ğŸ“·</i></button>
                            <button class="output-control-btn" id="fullscreenBtn" title="å…¨å±">
                                <svg class="fullscreen-icon-expand" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                                </svg>
                                <svg class="fullscreen-icon-collapse" viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                    <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
                                </svg>
                            </button>
                            <button class="output-control-btn" onclick="hideOutput()" title="å…³é—­"><i>âŒ</i></button>
                        </div>
                    </div>
                    <!-- ç”»å¸ƒå®¹å™¨ -->
                    <div class="canvas-container" id="mycanvas">
                        <!-- æµ·é¾Ÿç»˜å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="console-output">
                        <pre id="output"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶æ  -->
    <div class="control-buttons" style="display: none;"></div>
    
    <!-- åº•éƒ¨æ§åˆ¶æŒ‰é’® -->
    <div class="bottom-control-buttons">
        <button class="control-btn" title="æ’¤é”€" id="undoBtn">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#666">
                <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
            </svg>
        </button>
        <button class="control-btn" title="é‡åš" id="redoBtn">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="#666">
                <path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/>
            </svg>
        </button>
        <span class="zoom-controls">
            <button class="control-btn" title="ç¼©å°" id="zoomOutBtnBottom">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="#666">
                    <path d="M19 13H5v-2h14v2z"/>
                </svg>
            </button>
            <span class="zoom-level-bottom">100%</span>
            <button class="control-btn" title="æ”¾å¤§" id="zoomInBtnBottom">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="#666">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </button>
        </span>
        <button class="action-btn debug-btn" id="debugBtn" title="è°ƒè¯•">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="white">
                <path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5c-.49 0-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/>
            </svg>
            <span>è°ƒè¯•</span>
        </button>
        <button class="action-btn run-btn-bottom" id="runBtnBottom" title="è¿è¡Œ">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="white">
                <path d="M8 5v14l11-7z"/>
            </svg>
            <span>è¿è¡Œ</span>
        </button>
        <button class="action-btn stop-btn-bottom" id="stopBtnBottom" title="åœæ­¢" onclick="stopExecution()">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="white">
                <path d="M6 6h12v12H6z"/>
            </svg>
            <span>åœæ­¢</span>
        </button>
    </div>
    
    <!-- å·¥å…·æŒ‰é’® -->
    <div class="tool-buttons">
        <button class="tool-btn" title="AIåŠ©æ‰‹" id="aiAssistantBtn">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#FF9800">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                <path d="M13 12h2v-2h-2v2zm-6 0h2V7H7v5z"/>
            </svg>
        </button>
        <button class="tool-btn" title="æŸ¥æ‰¾ä»£ç " id="searchBtn">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#FF9800">
                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
        </button>
        <button class="tool-btn" title="é¢œè‰²å·¥å…·" id="colorToolBtn">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#FF9800">
                <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
            </svg>
        </button>
        <button class="tool-btn" title="æ§åˆ¶å°" id="consoleBtn">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="#FF9800">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 14H4v-4h11v4zm0-5H4V9h11v4zm5 5h-4V9h4v9z"/>
            </svg>
        </button>
    </div>
    
    <!-- AIåŠ©æ‰‹ -->
    <div class="ai-assistant" style="display: none;">
        <div class="ai-avatar">ğŸ¤–</div>
        <div class="ai-message">
            ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ç¼–ç¨‹åŠ©æ‰‹å°æµ·é¾Ÿï¼Œå¿«æ¥ä¸æˆ‘å¯¹è¯å§ï¼
        </div>
    </div>

    <!-- æ·»åŠ åº•éƒ¨æ§åˆ¶å°HTML -->
    <div class="bottom-console" id="bottomConsole">
        <div class="console-header">
            <div class="console-title">æ§åˆ¶å°</div>
            <div class="console-controls">
                <button class="console-control-btn" title="æ¸…é™¤" id="clearConsoleBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
                <button class="console-control-btn" title="å…³é—­" id="closeConsoleBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="console-content" id="consoleContent">
            &gt; æ¬¢è¿ä½¿ç”¨Pythonæ§åˆ¶å°ï¼Œå¼€å§‹è¾“å…¥ä»£ç å§ï¼
        </div>
    </div>

    <!-- æ·»åŠ è°ƒè¯•æ§åˆ¶å°HTML -->
    <div class="debug-console" id="debugConsole">
        <div class="debug-header">
            <div class="debug-title">è°ƒè¯•æ§åˆ¶å°</div>
            <div class="debug-controls">
                <button class="debug-control-btn" title="æ­¥è¿›" id="stepInBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19 15l-6 6-1.42-1.42L15.17 16H4V4h2v10h9.17l-3.59-3.58L13 9l6 6z"/>
                    </svg>
                    æ­¥è¿›
                </button>
                <button class="debug-control-btn" title="è·³è¿‡" id="stepOverBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M15.5 5H11l5 5-5 5h4.5l5-5z"/>
                    </svg>
                    è·³è¿‡
                </button>
                <button class="debug-control-btn" title="ç»§ç»­" id="continueBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    ç»§ç»­
                </button>
                <button class="debug-control-btn" title="åœæ­¢" id="stopDebugBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 6h12v12H6z"/>
                    </svg>
                    åœæ­¢
                </button>
                <button class="debug-control-btn" title="å…³é—­" id="closeDebugBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="debug-panel">
            <div class="debug-variables">
                <h3>å˜é‡</h3>
                <div id="debugVariables">
                    <div>å°šæœªå¼€å§‹è°ƒè¯•</div>
                </div>
            </div>
            <div class="debug-console-output" id="debugOutput">
                &gt; è°ƒè¯•ä¼šè¯å·²å‡†å¤‡å°±ç»ªã€‚ç‚¹å‡»"ç»§ç»­"å¼€å§‹è°ƒè¯•ã€‚
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å³é”®èœå•HTML -->
    <div class="context-menu" id="folderContextMenu">
        <div class="context-menu-item" id="renameItem">
            <svg class="context-menu-icon" viewBox="0 0 24 24" width="16" height="16" fill="#555">
                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            é‡å‘½å
        </div>
        <div class="context-menu-item" id="duplicateItem">
            <svg class="context-menu-icon" viewBox="0 0 24 24" width="16" height="16" fill="#555">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
            </svg>
            åˆ›å»ºå‰¯æœ¬
        </div>
        <div class="context-menu-item delete-item" id="deleteItem">
            <svg class="context-menu-icon" viewBox="0 0 24 24" width="16" height="16" fill="#F44336">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
            åˆ é™¤
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="copyNameItem">
            <svg class="context-menu-icon" viewBox="0 0 24 24" width="16" height="16" fill="#555">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm-1 4l6 6v10c0 1.1-.9 2-2 2H7.99C6.89 23 6 22.1 6 21l.01-14c0-1.1.89-2 1.99-2h7zm-1 7h5.5L14 6.5V12z"/>
            </svg>
            å¤åˆ¶åç§°
        </div>
        <div class="context-menu-item" id="copyPathItem">
            <svg class="context-menu-icon" viewBox="0 0 24 24" width="16" height="16" fill="#555">
                <path d="M3 3v18h18V3H3zm16 16H5V5h14v14zM11 7h2v2h-2zM7 7h2v2H7zm8 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2zm-8 4h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/>
            </svg>
            å¤åˆ¶ç›¸å¯¹è·¯å¾„
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="exportItem">
            <svg class="context-menu-icon" viewBox="0 0 24 24" width="16" height="16" fill="#555">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            å¯¼å‡º
        </div>
    </div>

    <script type="text/javascript">
        // åˆå§‹åŒ–å˜é‡
        var isBlocksMode = false;
        var isRunning = false;
        var editor = null; // å£°æ˜å…¨å±€ç¼–è¾‘å™¨å˜é‡
        var executionTimeout = null;
        var currentZoom = 100; // å½“å‰ç¼©æ”¾çº§åˆ«
        
        // æ·»åŠ å…¨å±€å˜é‡æ¥å­˜å‚¨æ–‡ä»¶æ•°æ®
        var fileData = {
            "main.py": `import turtle

# åˆ›å»ºç”»ç¬”å¯¹è±¡
p = turtle.Turtle()
p.pensize(3)
p.pencolor('gold')

# è®¾ç½®è¾¹æ•°
n = 6

# å¤–å±‚å¾ªç¯ - ç»˜åˆ¶5ä¸ªå›¾å½¢
for j in range(5):
    # å†…å±‚å¾ªç¯ - ç»˜åˆ¶ä¸€ä¸ªnè¾¹å½¢
    for i in range(n):
        p.forward(100)
        p.left(int(360/n))
    # æ¯ä¸ªå›¾å½¢åæ—‹è½¬
    p.left(int(360/5))

print("ç»˜åˆ¶å®Œæˆ")`
        };

        var currentOpenFile = "main.py";
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            initCodeMirror();
            
            // åˆå§‹åŒ–main.pyæ–‡ä»¶
            var mainFileItem = document.querySelector('.file-item');
            if (mainFileItem) {
                mainFileItem.setAttribute('data-filename', 'main.py');
                mainFileItem.addEventListener('click', function() {
                    openFile('main.py');
                });
            }
            
            // åˆå§‹åŒ–æ–‡ä»¶æ ‡ç­¾é¡µ
            updateFileTabs('main.py');
            
            // ç»‘å®šç¼–è¾‘å™¨å˜æ›´äº‹ä»¶ï¼Œè‡ªåŠ¨ä¿å­˜
            if (editor) {
                editor.on('change', function() {
                    if (currentOpenFile) {
                        fileData[currentOpenFile] = editor.getValue();
                    }
                });
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('blocksBtn').addEventListener('click', switchToBlocksMode);
            document.getElementById('codeBtn').addEventListener('click', switchToCodeMode);
            
            // ç»‘å®šæµ·é¾Ÿå›¾æ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('gridBtn').addEventListener('click', toggleGrid);
            document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
            document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
            document.getElementById('resetZoomBtn').addEventListener('click', resetZoom);
            document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            
            // ç»‘å®šåº•éƒ¨æ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            document.getElementById('zoomOutBtnBottom').addEventListener('click', zoomOut);
            document.getElementById('zoomInBtnBottom').addEventListener('click', zoomIn);
            document.getElementById('debugBtn').addEventListener('click', debugCode);
            document.getElementById('runBtnBottom').addEventListener('click', runit);
            document.getElementById('stopBtnBottom').addEventListener('click', stopExecution);
            
            // ç»‘å®šå³ä¾§å·¥å…·æŒ‰é’®äº‹ä»¶
            document.getElementById('searchBtn').addEventListener('click', openSearch);
            document.getElementById('colorToolBtn').addEventListener('click', openColorTool);
            document.getElementById('consoleBtn').addEventListener('click', toggleConsole);
            
            // ä¸ºAIåŠ©æ‰‹æŒ‰é’®æ·»åŠ é¼ æ ‡æ‚¬åœå’Œç§»å‡ºäº‹ä»¶
            document.getElementById('aiAssistantBtn').addEventListener('mouseenter', showAIAssistant);
            document.getElementById('aiAssistantBtn').addEventListener('mouseleave', hideAIAssistant);
            
            // ç»‘å®šæ§åˆ¶å°æŒ‰é’®äº‹ä»¶
            document.getElementById('closeConsoleBtn').addEventListener('click', closeConsole);
            document.getElementById('clearConsoleBtn').addEventListener('click', clearConsole);
            
            // ç»‘å®šè°ƒè¯•æ§åˆ¶å°æŒ‰é’®äº‹ä»¶
            document.getElementById('closeDebugBtn').addEventListener('click', closeDebugConsole);
            document.getElementById('stepInBtn').addEventListener('click', stepInDebug);
            document.getElementById('stepOverBtn').addEventListener('click', stepOverDebug);
            document.getElementById('continueBtn').addEventListener('click', continueDebug);
            document.getElementById('stopDebugBtn').addEventListener('click', stopDebug);
            
            // ç»‘å®šä¾§è¾¹æ æŒ‰é’®äº‹ä»¶
            document.getElementById('foldSidebarBtn').addEventListener('click', toggleSidebar);
            document.getElementById('addPyFileBtn').addEventListener('click', addPythonFile);
            document.getElementById('addResourceBtn').addEventListener('click', addResource);
            document.getElementById('addFolderBtn').addEventListener('click', addFolder);
            document.getElementById('addLocalFileBtn').addEventListener('click', addLocalFile);
            
            // ç»‘å®šå³é”®èœå•äº‹ä»¶
            initContextMenu();
            
            // åŒæ­¥ä¸¤ä¸ªåœ°æ–¹çš„ç¼©æ”¾æ˜¾ç¤º
            var zoomLevelBottom = document.querySelector('.zoom-level-bottom');
            zoomLevelBottom.textContent = currentZoom + '%';
        });

        // åˆå§‹åŒ–å³é”®èœå•
        let lastRightClickedItem = null;

        function initContextMenu() {
            // é˜»æ­¢é»˜è®¤çš„å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                // é˜»æ­¢æ‰€æœ‰å³é”®ç‚¹å‡»é»˜è®¤èœå•
                e.preventDefault();
                
                // éšè—æ‰€æœ‰å³é”®èœå•
                document.querySelectorAll('.context-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
                
                // è·å–å³é”®ç‚¹å‡»çš„å…ƒç´ 
                var target = e.target;
                
                // æŸ¥æ‰¾æœ€è¿‘çš„æ–‡ä»¶é¡¹å…ƒç´ 
                while (target && !target.classList.contains('file-item')) {
                    target = target.parentElement;
                }
                
                if (target && target.classList.contains('file-item')) {
                    // ä¿å­˜å½“å‰å³é”®ç‚¹å‡»çš„é¡¹ç›®
                    lastRightClickedItem = target;
                    
                    // æ£€æŸ¥æ˜¯æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹
                    var isFolder = target.querySelector('.file-icon').textContent.includes('ğŸ“');
                    
                    if (isFolder) {
                        // æ˜¾ç¤ºæ–‡ä»¶å¤¹ä¸Šä¸‹æ–‡èœå•
                        var contextMenu = document.getElementById('folderContextMenu');
                        
                        // è®¾ç½®èœå•ä½ç½®
                        contextMenu.style.left = e.pageX + 'px';
                        contextMenu.style.top = e.pageY + 'px';
                        contextMenu.style.display = 'block';
                    }
                }
            });
            
            // ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å…³é—­å³é”®èœå•
            document.addEventListener('click', function() {
                document.querySelectorAll('.context-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            });
            
            // ç»‘å®šå³é”®èœå•é¡¹äº‹ä»¶
            document.getElementById('renameItem').addEventListener('click', renameItem);
            document.getElementById('duplicateItem').addEventListener('click', duplicateItem);
            document.getElementById('deleteItem').addEventListener('click', deleteItem);
            document.getElementById('copyNameItem').addEventListener('click', copyItemName);
            document.getElementById('copyPathItem').addEventListener('click', copyItemPath);
            document.getElementById('exportItem').addEventListener('click', exportItem);
        }

        // é‡å‘½åé¡¹ç›®
        function renameItem() {
            if (lastRightClickedItem) {
                var nameSpan = lastRightClickedItem.querySelector('span:not(.file-icon)');
                var oldName = nameSpan.textContent;
                var newName = prompt("è¯·è¾“å…¥æ–°åç§°:", oldName);
                
                if (newName && newName !== oldName) {
                    nameSpan.textContent = newName;
                }
            }
        }

        // åˆ›å»ºå‰¯æœ¬
        function duplicateItem() {
            if (lastRightClickedItem) {
                var nameSpan = lastRightClickedItem.querySelector('span:not(.file-icon)');
                var iconSpan = lastRightClickedItem.querySelector('.file-icon');
                var name = nameSpan.textContent;
                var icon = iconSpan.textContent;
                
                // åˆ›å»ºå‰¯æœ¬
                var fileNav = document.querySelector('.file-nav');
                var newItem = document.createElement('div');
                newItem.className = 'file-item';
                
                // æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šå‰¯æœ¬åç§°
                var newName = name.includes('.') ? 
                    name.replace(/(\.[^.]+)$/, ' å‰¯æœ¬$1') : 
                    name + ' å‰¯æœ¬';
                
                newItem.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span>${newName}</span>
                `;
                
                fileNav.appendChild(newItem);
                
                // ä¸ºæ–°é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                newItem.addEventListener('click', function() {
                    document.querySelectorAll('.file-item').forEach(function(item) {
                        item.classList.remove('active');
                    });
                    newItem.classList.add('active');
                });
            }
        }

        // åˆ é™¤é¡¹ç›®
        function deleteItem() {
            if (lastRightClickedItem) {
                var nameSpan = lastRightClickedItem.querySelector('span:not(.file-icon)');
                var name = nameSpan.textContent;
                
                if (confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿ`)) {
                    lastRightClickedItem.remove();
                }
            }
        }

        // å¤åˆ¶åç§°
        function copyItemName() {
            if (lastRightClickedItem) {
                var nameSpan = lastRightClickedItem.querySelector('span:not(.file-icon)');
                var name = nameSpan.textContent;
                
                // ä½¿ç”¨clipboard APIå¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(name)
                    .then(() => {
                        showToast('å·²å¤åˆ¶: ' + name);
                    })
                    .catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥: ', err);
                    });
            }
        }

        // å¤åˆ¶ç›¸å¯¹è·¯å¾„
        function copyItemPath() {
            if (lastRightClickedItem) {
                var nameSpan = lastRightClickedItem.querySelector('span:not(.file-icon)');
                var name = nameSpan.textContent;
                
                // æ¨¡æ‹Ÿç›¸å¯¹è·¯å¾„ - åœ¨å®é™…åº”ç”¨ä¸­åº”è·å–çœŸå®è·¯å¾„
                var path = '/workspace/' + name;
                
                // ä½¿ç”¨clipboard APIå¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(path)
                    .then(() => {
                        showToast('å·²å¤åˆ¶è·¯å¾„: ' + path);
                    })
                    .catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥: ', err);
                    });
            }
        }

        // å¯¼å‡ºé¡¹ç›®
        function exportItem() {
            if (lastRightClickedItem) {
                var nameSpan = lastRightClickedItem.querySelector('span:not(.file-icon)');
                var name = nameSpan.textContent;
                
                alert(`æ­£åœ¨å¯¼å‡º "${name}"...`);
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å¤„ç†çœŸå®çš„å¯¼å‡ºé€»è¾‘
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            // åˆ›å»ºtoastå…ƒç´ 
            var toast = document.createElement('div');
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = 'rgba(0,0,0,0.7)';
            toast.style.color = 'white';
            toast.style.padding = '8px 16px';
            toast.style.borderRadius = '4px';
            toast.style.zIndex = '2000';
            toast.innerText = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(toast);
            
            // 3ç§’åç§»é™¤
            setTimeout(function() {
                document.body.removeChild(toast);
            }, 3000);
        }
        
        // åˆå§‹åŒ–CodeMirror
        function initCodeMirror() {
            try {
                editor = CodeMirror.fromTextArea(document.getElementById("yourcode"), {
                    mode: {
                        name: "python",
                        version: 3,
                        singleLineStringErrors: false
                    },
                    lineNumbers: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    theme: "default",
                    styleActiveLine: true,
                    highlightSelectionMatches: true,
                    scrollbarStyle: "simple",
                    viewportMargin: Infinity, // é‡è¦ï¼šä½¿CodeMirroræ¸²æŸ“æ‰€æœ‰å†…å®¹è€Œéä»…å¯è§éƒ¨åˆ†
                    lineWrapping: true // å…è®¸é•¿è¡Œè‡ªåŠ¨æ¢è¡Œ
                });
                
                // å°†ç¼–è¾‘å™¨ä¿å­˜åˆ°windowå¯¹è±¡ï¼Œä¿æŒå‘åå…¼å®¹
                window.CodeMirrorEditor = editor;
                
                // ç›‘å¬å†…å®¹å˜åŒ–ï¼Œè§¦å‘ç¼–è¾‘å™¨é«˜åº¦æ›´æ–°
                editor.on("change", function() {
                    editor.refresh();
                });
                
                console.log("CodeMirrorç¼–è¾‘å™¨æˆåŠŸåˆå§‹åŒ–");
            } catch(e) {
                console.error("CodeMirroråˆå§‹åŒ–é”™è¯¯:", e);
                
                // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•å¤„ç†æ–‡æœ¬åŒºåŸŸ
                var codeTextarea = document.getElementById("yourcode");
                if(codeTextarea) {
                    codeTextarea.style.display = "block";
                    codeTextarea.style.width = "100%";
                    codeTextarea.style.height = "auto"; // è‡ªåŠ¨é«˜åº¦
                    codeTextarea.rows = 20; // åˆå§‹è¡Œæ•°
                    codeTextarea.style.fontFamily = "Consolas, Monaco, monospace";
                    codeTextarea.style.fontSize = "15px";
                    
                    // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬ï¼Œè°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
                    codeTextarea.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = (this.scrollHeight) + 'px';
                    });
                }
            }
        }
        
        // åˆ‡æ¢åˆ°ç§¯æœ¨æ¨¡å¼
        function switchToBlocksMode() {
            document.body.classList.add('blocks-mode');
            isBlocksMode = true;
            document.getElementById('blocksBtn').classList.add('active');
            document.getElementById('codeBtn').classList.remove('active');
        }
        
        // åˆ‡æ¢åˆ°ä»£ç æ¨¡å¼
        function switchToCodeMode() {
            document.body.classList.remove('blocks-mode');
            isBlocksMode = false;
            document.getElementById('codeBtn').classList.add('active');
            document.getElementById('blocksBtn').classList.remove('active');
        }
        
        // è¾“å‡ºå‡½æ•°
        function outf(text) {
            var mypre = document.getElementById("output");
            mypre.innerHTML = mypre.innerHTML + text;
        }

        // æ–‡ä»¶è¯»å–å‡½æ•°
        function builtinRead(x) {
            if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                throw "File not found: '" + x + "'";
            return Sk.builtinFiles["files"][x];
        }
        
        // è¿è¡Œä»£ç 
        function runit() {
            // æ›´æ–°çŠ¶æ€
            isRunning = true;
            document.getElementById('runBtnBottom').style.display = 'none';
            document.getElementById('stopBtnBottom').style.display = 'flex';
            
            // æ˜¾ç¤ºè¾“å‡ºå®¹å™¨
            var outputContainer = document.querySelector('.output-container');
            outputContainer.style.display = 'flex';
            
            // è·å–ä»£ç 
            var prog = editor.getValue();
            
            // ç§»é™¤turtle.done()è°ƒç”¨ï¼Œé˜²æ­¢ç¨‹åºæŒ‚èµ·
            prog = prog.replace(/turtle\.done\(\)/g, "# è‡ªåŠ¨ç§»é™¤ turtle.done()");
            
            // æ¸…é™¤è¾“å‡º
            var mypre = document.getElementById("output");
            mypre.innerHTML = '';
            
            // æ¸…é™¤ç”»å¸ƒå®¹å™¨ä¸­çš„æ‰€æœ‰canvaså…ƒç´ 
            var mycanvas = document.getElementById("mycanvas");
            mycanvas.innerHTML = '';
            
            // é…ç½®Skulpt
            Sk.pre = "output";
            Sk.configure({
                output: outf,
                read: builtinRead,
                __future__: Sk.python3,
                inputfun: function(prompt) {
                    return window.prompt(prompt);
                },
                inputfunTakesPrompt: true
            });
            
            // è®¾ç½®æµ·é¾Ÿå›¾å½¢ç›®æ ‡ï¼Œé€‚åº”æ›´å¤§çš„ç”»å¸ƒ
            (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';
            (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).width = 800;
            (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).height = 600;
            
            // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢æ— é™å¾ªç¯
            executionTimeout = setTimeout(function() {
                stopExecution();
                mypre.innerHTML += '<div class="error-message">è­¦å‘Šï¼šç¨‹åºæ‰§è¡Œè¶…æ—¶ï¼Œå¯èƒ½å­˜åœ¨æ— é™å¾ªç¯ã€‚</div>';
            }, 30000); // 30ç§’è¶…æ—¶
            
            // æ‰§è¡Œä»£ç 
            var myPromise = Sk.misceval.asyncToPromise(function() {
                return Sk.importMainWithBody("<stdin>", false, prog, true);
            });
            
            myPromise.then(
                function(mod) {
                    console.log('ä»£ç æ‰§è¡ŒæˆåŠŸ');
                    mypre.innerHTML += '<div class="success-message">ç»˜åˆ¶å®Œæˆï¼ç¨‹åºæ‰§è¡ŒæˆåŠŸï¼</div>';
                    
                    // æ‰§è¡ŒæˆåŠŸåï¼Œä»…æ›´æ–°æŒ‰é’®çŠ¶æ€ï¼Œä¸å…³é—­æµ·é¾Ÿå›¾åŒºåŸŸ
                    isRunning = false;
                    document.getElementById('runBtnBottom').style.display = 'flex';
                    document.getElementById('stopBtnBottom').style.display = 'none';
                    
                    // æ¸…é™¤è¶…æ—¶
                    if (executionTimeout) {
                        clearTimeout(executionTimeout);
                        executionTimeout = null;
                    }
                    
                    // ç¡®ä¿åªä¿ç•™ä¸€ä¸ªcanvas
                    var canvases = document.querySelectorAll('#mycanvas canvas');
                    if (canvases.length > 1) {
                        // ä¿ç•™æœ€åä¸€ä¸ªcanvasï¼Œåˆ é™¤å…¶ä»–æ‰€æœ‰canvas
                        var lastCanvas = canvases[canvases.length - 1];
                        mycanvas.innerHTML = '';
                        mycanvas.appendChild(lastCanvas);
                    }
                    
                    // ç¡®ä¿canvasæ ·å¼æ­£ç¡®
                    var canvas = mycanvas.querySelector('canvas');
                    if (canvas) {
                        canvas.style.display = 'block';
                        canvas.style.margin = 'auto';
                        canvas.style.position = 'relative';
                        canvas.style.zIndex = '1';
                        
                        // åº”ç”¨å½“å‰ç¼©æ”¾
                        applyZoom();
                    }
                },
                function(err) {
                    console.log('ä»£ç æ‰§è¡Œé”™è¯¯:', err.toString());
                    mypre.innerHTML += '<div class="error-message">é”™è¯¯: ' + err.toString() + '</div>';
                    stopExecution();
                }
            );
        }

        // åœæ­¢æ‰§è¡Œ
        function stopExecution() {
            // æ›´æ–°çŠ¶æ€
            isRunning = false;
            document.getElementById('runBtnBottom').style.display = 'flex';
            document.getElementById('stopBtnBottom').style.display = 'none';
            
            // éšè—è¾“å‡ºåŒºåŸŸ
            document.querySelector('.output-container').style.display = 'none';
            
            // æ¸…é™¤è¶…æ—¶
            if (executionTimeout) {
                clearTimeout(executionTimeout);
                executionTimeout = null;
            }
        }
        
        // éšè—è¾“å‡º
        function hideOutput() {
            document.querySelector('.output-container').style.display = 'none';
        }
        
        // æ–‡ä»¶æ“ä½œå‡½æ•°
        function newFile() {
            editor.setValue("");
        }

        // æ‰“å¼€æ–‡ä»¶å‡½æ•°
        function openFile(fileName) {
            // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›
            if (!fileData[fileName]) {
                console.error("æ–‡ä»¶ä¸å­˜åœ¨:", fileName);
                return;
            }
            
            // æ›´æ–°å½“å‰æ‰“å¼€çš„æ–‡ä»¶
            currentOpenFile = fileName;
            
            // æ›´æ–°ä¾§è¾¹æ é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.file-item').forEach(function(item) {
                item.classList.remove('active');
                
                if (item.getAttribute('data-filename') === fileName) {
                    item.classList.add('active');
                }
            });
            
            // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹
            if (editor) {
                editor.setValue(fileData[fileName]);
                editor.clearHistory(); // æ¸…é™¤æ’¤é”€å†å²
            }
            
            // æ›´æ–°æ–‡ä»¶æ ‡ç­¾é¡µ
            updateFileTabs(fileName);
        }

        // æ›´æ–°æ–‡ä»¶æ ‡ç­¾é¡µ
        function updateFileTabs(fileName) {
            var fileTabs = document.querySelector('.file-tabs');
            fileTabs.innerHTML = '';
            
            var fileTab = document.createElement('div');
            fileTab.className = 'file-tab';
            fileTab.innerHTML = `
                ${fileName}
                <span class="file-tab-close">Ã—</span>
            `;
            fileTabs.appendChild(fileTab);
            
            // ä¸ºå…³é—­æŒ‰é’®æ·»åŠ äº‹ä»¶
            var closeBtn = fileTab.querySelector('.file-tab-close');
            closeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                closeFile(fileName);
            });
        }

        // å…³é—­æ–‡ä»¶
        function closeFile(fileName) {
            // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸å…è®¸å…³é—­
            var fileCount = Object.keys(fileData).length;
            if (fileCount <= 1) {
                alert("è‡³å°‘ä¿ç•™ä¸€ä¸ªæ–‡ä»¶ï¼");
                return;
            }
            
            // ç¡®è®¤æ˜¯å¦å…³é—­
            if (confirm("ç¡®å®šè¦å…³é—­ " + fileName + " å—ï¼Ÿ\næ³¨æ„ï¼šè¿™å°†åˆ é™¤æ­¤æ–‡ä»¶ï¼")) {
                // ä¿å­˜å½“å‰ç¼–è¾‘å™¨å†…å®¹åˆ°æ–‡ä»¶æ•°æ®
                saveCurrentFile();
                
                // å¦‚æœå…³é—­çš„æ˜¯å½“å‰æ–‡ä»¶ï¼Œæ‰“å¼€å¦ä¸€ä¸ªæ–‡ä»¶
                if (currentOpenFile === fileName) {
                    var nextFile = Object.keys(fileData).find(function(name) {
                        return name !== fileName;
                    });
                    
                    // åˆ é™¤æ–‡ä»¶æ•°æ®
                    delete fileData[fileName];
                    
                    // åˆ é™¤å¯¹åº”çš„æ–‡ä»¶é¡¹
                    var fileItem = document.querySelector(`.file-item[data-filename="${fileName}"]`);
                    if (fileItem) {
                        fileItem.remove();
                    }
                    
                    // æ‰“å¼€ä¸‹ä¸€ä¸ªæ–‡ä»¶
                    if (nextFile) {
                        openFile(nextFile);
                    }
                } else {
                    // åˆ é™¤æ–‡ä»¶æ•°æ®
                    delete fileData[fileName];
                    
                    // åˆ é™¤å¯¹åº”çš„æ–‡ä»¶é¡¹
                    var fileItem = document.querySelector(`.file-item[data-filename="${fileName}"]`);
                    if (fileItem) {
                        fileItem.remove();
                    }
                }
            }
        }

        // ä¿å­˜å½“å‰æ–‡ä»¶
        function saveCurrentFile() {
            if (currentOpenFile && editor) {
                fileData[currentOpenFile] = editor.getValue();
            }
        }

        function saveFile() {
            var text = editor.getValue();
            var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'code.py';
            a.click();
        }

        function shareCode() {
            var text = editor.getValue();
            var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'shared_code.py';
            a.click();
        }

        // åˆ‡æ¢æ§åˆ¶å°æ˜¾ç¤º - ä¿®æ”¹ä¸ºåº•éƒ¨æ§åˆ¶å°
        function toggleConsole() {
            var bottomConsole = document.getElementById('bottomConsole');
            if (bottomConsole.style.display === 'flex') {
                bottomConsole.style.display = 'none';
            } else {
                bottomConsole.style.display = 'flex';
                // éšè—è°ƒè¯•æ§åˆ¶å°
                document.getElementById('debugConsole').style.display = 'none';
            }
        }

        // å…³é—­æ§åˆ¶å°
        function closeConsole() {
            document.getElementById('bottomConsole').style.display = 'none';
        }

        // æ¸…é™¤æ§åˆ¶å°å†…å®¹
        function clearConsole() {
            document.getElementById('consoleContent').innerHTML = '&gt; æ§åˆ¶å°å·²æ¸…é™¤';
        }

        // è°ƒè¯•ä»£ç  - å®ç°è°ƒè¯•åŠŸèƒ½
        function debugCode() {
            var debugConsole = document.getElementById('debugConsole');
            if (debugConsole.style.display === 'flex') {
                debugConsole.style.display = 'none';
            } else {
                debugConsole.style.display = 'flex';
                // éšè—åº•éƒ¨æ§åˆ¶å°
                document.getElementById('bottomConsole').style.display = 'none';
                
                // è·å–ä»£ç å¹¶å‡†å¤‡è°ƒè¯•
                var prog = editor.getValue();
                var lines = prog.split('\n');
                
                // é«˜äº®ç¬¬ä¸€è¡Œä»£ç ï¼Œæ¨¡æ‹Ÿè°ƒè¯•å¼€å§‹
                if (editor.setLineClass) {
                    // æ—§ç‰ˆCodeMirror
                    editor.setLineClass(0, null, 'debug-line');
                } else if (editor.addLineClass) {
                    // æ–°ç‰ˆCodeMirror
                    editor.addLineClass(0, 'background', 'debug-line');
                }
                
                // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                document.getElementById('debugOutput').innerHTML = '&gt; è°ƒè¯•å·²å¼€å§‹äºç¬¬1è¡Œ\n&gt; å‡†å¤‡æ‰§è¡Œ: ' + lines[0];
                
                // æ¨¡æ‹Ÿä¸€äº›å˜é‡
                document.getElementById('debugVariables').innerHTML = `
                    <div><strong>p</strong>: undefined</div>
                    <div><strong>n</strong>: undefined</div>
                    <div><strong>i</strong>: undefined</div>
                    <div><strong>j</strong>: undefined</div>
                `;
            }
        }

        // å…³é—­è°ƒè¯•æ§åˆ¶å°
        function closeDebugConsole() {
            document.getElementById('debugConsole').style.display = 'none';
            
            // æ¸…é™¤ä»»ä½•è°ƒè¯•é«˜äº®
            if (editor.removeLineClass) {
                for (var i = 0; i < editor.lineCount(); i++) {
                    editor.removeLineClass(i, 'background', 'debug-line');
                }
            }
        }

        // è°ƒè¯•æ­¥è¿›å‡½æ•°
        function stepInDebug() {
            simulateDebugStep('æ­¥è¿›');
        }

        // è°ƒè¯•è·³è¿‡å‡½æ•°
        function stepOverDebug() {
            simulateDebugStep('è·³è¿‡');
        }

        // è°ƒè¯•ç»§ç»­å‡½æ•°
        function continueDebug() {
            simulateDebugStep('ç»§ç»­');
        }

        // åœæ­¢è°ƒè¯•
        function stopDebug() {
            closeDebugConsole();
            document.getElementById('debugOutput').innerHTML = '&gt; è°ƒè¯•å·²åœæ­¢';
        }

        // æ¨¡æ‹Ÿè°ƒè¯•æ­¥éª¤
        function simulateDebugStep(action) {
            var debugOutput = document.getElementById('debugOutput');
            var currentLine = 0;
            
            // æŸ¥æ‰¾å½“å‰é«˜äº®çš„è¡Œ
            if (editor.lineCount) {
                for (var i = 0; i < editor.lineCount(); i++) {
                    if (editor.lineInfo(i).bgClass === 'debug-line') {
                        currentLine = i;
                        break;
                    }
                }
            }
            
            // ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
            var nextLine = currentLine + 1;
            if (nextLine >= editor.lineCount()) {
                nextLine = 0;
            }
            
            // æ¸…é™¤å½“å‰è¡Œé«˜äº®
            if (editor.removeLineClass) {
                editor.removeLineClass(currentLine, 'background', 'debug-line');
            }
            
            // é«˜äº®ä¸‹ä¸€è¡Œ
            if (editor.addLineClass) {
                editor.addLineClass(nextLine, 'background', 'debug-line');
            }
            
            // è·å–è¡Œå†…å®¹
            var line = editor.getLine(nextLine);
            
            // æ›´æ–°è°ƒè¯•è¾“å‡º
            debugOutput.innerHTML += '\n&gt; ' + action + 'åˆ°ç¬¬' + (nextLine + 1) + 'è¡Œ\n&gt; å‡†å¤‡æ‰§è¡Œ: ' + line;
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°è¾“å‡º
            debugOutput.scrollTop = debugOutput.scrollHeight;
            
            // æ¨¡æ‹Ÿæ›´æ–°å˜é‡
            updateDebugVariables(nextLine);
        }

        // æ›´æ–°è°ƒè¯•å˜é‡æ˜¾ç¤º
        function updateDebugVariables(lineNum) {
            var debugVariables = document.getElementById('debugVariables');
            var code = editor.getValue();
            
            // è¿™é‡Œåªæ˜¯ç®€å•æ¨¡æ‹Ÿï¼Œå®é™…ä¸Šéœ€è¦åˆ†æä»£ç æ¥ç¡®å®šå˜é‡å€¼
            if (lineNum > 3) {
                debugVariables.innerHTML = `
                    <div><strong>p</strong>: Turtleå¯¹è±¡</div>
                    <div><strong>n</strong>: 6</div>
                    <div><strong>i</strong>: ${Math.min(lineNum % 6, 5)}</div>
                    <div><strong>j</strong>: ${Math.floor(lineNum / 7)}</div>
                `;
            } else if (lineNum > 1) {
                debugVariables.innerHTML = `
                    <div><strong>p</strong>: Turtleå¯¹è±¡</div>
                    <div><strong>n</strong>: undefined</div>
                    <div><strong>i</strong>: undefined</div>
                    <div><strong>j</strong>: undefined</div>
                `;
            }
        }

        // æ˜¾ç¤º/éšè—ç½‘æ ¼
        function toggleGrid() {
            var canvas = document.getElementById('mycanvas');
            canvas.classList.toggle('grid-background');
        }

        // æ”¾å¤§æµ·é¾Ÿå›¾
        function zoomIn() {
            if (currentZoom < 200) {
                currentZoom += 10;
                applyZoom();
            }
        }

        // ç¼©å°æµ·é¾Ÿå›¾
        function zoomOut() {
            if (currentZoom > 50) {
                currentZoom -= 10;
                applyZoom();
            }
        }

        // é‡ç½®ç¼©æ”¾
        function resetZoom() {
            currentZoom = 100;
            applyZoom();
        }

        // åº”ç”¨ç¼©æ”¾
        function applyZoom() {
            var canvases = document.querySelectorAll('#mycanvas canvas');
            var zoomLevel = document.getElementById('zoomLevel');
            var zoomLevelBottom = document.querySelector('.zoom-level-bottom');
            
            zoomLevel.textContent = currentZoom + '%';
            zoomLevelBottom.textContent = currentZoom + '%';
            
            canvases.forEach(function(canvas) {
                canvas.style.transform = 'scale(' + (currentZoom / 100) + ')';
                canvas.style.transformOrigin = 'center center';
            });
        }

        // æˆªå›¾åŠŸèƒ½
        function takeScreenshot() {
            var container = document.getElementById('mycanvas');
            var canvas = container.querySelector('canvas');
            
            if (canvas) {
                try {
                    // åˆ›å»ºä¸´æ—¶é“¾æ¥ä¸‹è½½å›¾ç‰‡
                    var link = document.createElement('a');
                    link.download = 'turtle_drawing.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    console.error('æˆªå›¾å¤±è´¥:', e);
                    alert('æˆªå›¾å¤±è´¥ï¼š' + e.message);
                }
            } else {
                alert('æ²¡æœ‰å¯ç”¨çš„æµ·é¾Ÿå›¾å¯ä»¥æˆªå›¾');
            }
        }

        // å…¨å±æ˜¾ç¤º
        function toggleFullscreen() {
            var outputContainer = document.querySelector('.output-container');
            
            // åˆ‡æ¢æœ€å¤§åŒ–ç±»
            outputContainer.classList.toggle('maximized-output');
            
            // é‡æ–°è®¡ç®—canvaså®¹å™¨å¤§å°
            var canvasContainer = document.getElementById('mycanvas');
            
            // è°ƒæ•´canvaså¤§å°ä»¥é€‚åº”æ–°çš„å®¹å™¨å¤§å°
            setTimeout(function() {
                // é‡æ–°åº”ç”¨å½“å‰ç¼©æ”¾ï¼Œä½¿å›¾åƒæ­£ç¡®æ˜¾ç¤º
                applyZoom();
            }, 100);
        }

        // æ’¤é”€æ“ä½œ
        function undo() {
            if (editor && editor.undo) {
                editor.undo();
            }
        }

        // é‡åšæ“ä½œ
        function redo() {
            if (editor && editor.redo) {
                editor.redo();
            }
        }

        // æ˜¾ç¤ºAIåŠ©æ‰‹å¯¹è¯æ¡†
        function showAIAssistant() {
            var aiAssistant = document.querySelector('.ai-assistant');
            var aiButton = document.getElementById('aiAssistantBtn');
            
            // é‡æ–°å®šä½AIåŠ©æ‰‹å¯¹è¯æ¡†åˆ°æŒ‰é’®æ—è¾¹
            aiAssistant.style.position = 'fixed';
            var buttonRect = aiButton.getBoundingClientRect();
            aiAssistant.style.top = (buttonRect.top - 30) + 'px'; // å®šä½åˆ°æŒ‰é’®ä¸Šæ–¹
            aiAssistant.style.left = (buttonRect.left - 250) + 'px'; // å®šä½åˆ°æŒ‰é’®å·¦ä¾§
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            aiAssistant.style.display = 'flex';
        }

        // éšè—AIåŠ©æ‰‹å¯¹è¯æ¡†
        function hideAIAssistant() {
            var aiAssistant = document.querySelector('.ai-assistant');
            aiAssistant.style.display = 'none';
        }

        // æ‰“å¼€æŸ¥æ‰¾ä»£ç å¯¹è¯æ¡†
        function openSearch() {
            if (editor && editor.execCommand) {
                editor.execCommand('find');
            }
        }

        // æ‰“å¼€é¢œè‰²å·¥å…·
        function openColorTool() {
            alert('é¢œè‰²å·¥å…·åŠŸèƒ½æš‚æœªå®ç°');
        }

        // æŠ˜å /å±•å¼€ä¾§è¾¹æ 
        function toggleSidebar() {
            var sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // æ·»åŠ Pythonæ–‡ä»¶
        function addPythonFile() {
            var fileName = prompt("è¯·è¾“å…¥Pythonæ–‡ä»¶å:", "æ–°çš„ä»£ç .py");
            if (fileName) {
                // å¦‚æœæ²¡æœ‰.pyåç¼€ï¼Œæ·»åŠ å®ƒ
                if (!fileName.toLowerCase().endsWith('.py')) {
                    fileName += '.py';
                }
                
                // å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæç¤ºç”¨æˆ·
                if (fileData[fileName]) {
                    alert("æ–‡ä»¶ '" + fileName + "' å·²å­˜åœ¨!");
                    return;
                }
                
                // åˆ›å»ºæ–°çš„æ–‡ä»¶é¡¹
                var fileNav = document.querySelector('.file-nav');
                var fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.setAttribute('data-filename', fileName);
                fileItem.innerHTML = `
                    <span class="file-icon">ğŸ”¶</span>
                    <span>${fileName}</span>
                `;
                fileNav.appendChild(fileItem);
                
                // ä¸ºæ–°æ–‡ä»¶æ·»åŠ é»˜è®¤å†…å®¹
                fileData[fileName] = `# ${fileName}\n\nimport turtle\n\n# åœ¨æ­¤ç¼–å†™ä½ çš„ä»£ç \n`;
                
                // ä¸ºæ–°æ–‡ä»¶é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                fileItem.addEventListener('click', function() {
                    openFile(fileName);
                });
                
                // æ‰“å¼€æ–°æ–‡ä»¶
                openFile(fileName);
            }
        }

        // æ·»åŠ ç´ æ
        function addResource() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.txt,.csv';
            input.onchange = function(e) {
                if (e.target.files.length > 0) {
                    var fileName = e.target.files[0].name;
                    // åˆ›å»ºæ–°çš„ç´ æé¡¹
                    var fileNav = document.querySelector('.file-nav');
                    var fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span class="file-icon">ğŸ“„</span>
                        <span>${fileName}</span>
                    `;
                    fileNav.appendChild(fileItem);
                }
            };
            input.click();
        }

        // æ·»åŠ æ–‡ä»¶å¤¹
        function addFolder() {
            var folderName = prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:", "æ–°æ–‡ä»¶å¤¹");
            if (folderName) {
                // åˆ›å»ºæ–°çš„æ–‡ä»¶å¤¹é¡¹
                var fileNav = document.querySelector('.file-nav');
                var folderItem = document.createElement('div');
                folderItem.className = 'file-item';
                folderItem.innerHTML = `
                    <span class="file-icon">ğŸ“</span>
                    <span>${folderName}</span>
                `;
                fileNav.appendChild(folderItem);
                
                // ä¸ºæ–°æ–‡ä»¶å¤¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
                folderItem.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–æ–‡ä»¶é¡¹çš„activeç±»
                    document.querySelectorAll('.file-item').forEach(function(item) {
                        item.classList.remove('active');
                    });
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ–‡ä»¶é¡¹
                    folderItem.classList.add('active');
                });
            }
        }

        // æ·»åŠ æœ¬åœ°æ–‡ä»¶
        function addLocalFile() {
            var input = document.createElement('input');
            input.type = 'file';
            input.onchange = function(e) {
                if (e.target.files.length > 0) {
                    var fileName = e.target.files[0].name;
                    // åˆ›å»ºæ–°çš„æ–‡ä»¶é¡¹
                    var fileNav = document.querySelector('.file-nav');
                    var fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©ä¸åŒå›¾æ ‡
                    var fileExt = fileName.split('.').pop().toLowerCase();
                    var fileIcon = 'ğŸ“„'; // é»˜è®¤æ–‡ä»¶å›¾æ ‡
                    
                    if (['py', 'pyc', 'pyw'].includes(fileExt)) {
                        fileIcon = 'ğŸ”¶'; // Pythonæ–‡ä»¶å›¾æ ‡
                    } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(fileExt)) {
                        fileIcon = 'ğŸ–¼ï¸'; // å›¾ç‰‡æ–‡ä»¶å›¾æ ‡
                    } else if (['mp3', 'wav', 'ogg'].includes(fileExt)) {
                        fileIcon = 'ğŸ”Š'; // éŸ³é¢‘æ–‡ä»¶å›¾æ ‡
                    } else if (['mp4', 'avi', 'mov', 'wmv'].includes(fileExt)) {
                        fileIcon = 'ğŸ¬'; // è§†é¢‘æ–‡ä»¶å›¾æ ‡
                    } else if (['txt', 'md', 'rtf'].includes(fileExt)) {
                        fileIcon = 'ğŸ“'; // æ–‡æœ¬æ–‡ä»¶å›¾æ ‡
                    }
                    
                    fileItem.innerHTML = `
                        <span class="file-icon">${fileIcon}</span>
                        <span>${fileName}</span>
                    `;
                    fileNav.appendChild(fileItem);
                }
            };
            input.click();
        }
    </script>
</body>

</html>
